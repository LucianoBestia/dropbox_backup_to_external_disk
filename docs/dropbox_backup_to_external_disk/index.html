<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="dropbox_backup_to_external_disk lib.rs"><meta name="keywords" content="rust, rustlang, rust-lang, dropbox_backup_to_external_disk"><title>dropbox_backup_to_external_disk - Rust</title><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../light.css"  id="themeStyle"><link rel="stylesheet" type="text/css" href="../dark.css" disabled ><link rel="stylesheet" type="text/css" href="../ayu.css" disabled ><script id="default-settings"></script><script src="../storage.js"></script><script src="../crates.js"></script><noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="icon" type="image/svg+xml" href="../favicon.svg">
<link rel="alternate icon" type="image/png" href="../favicon-16x16.png">
<link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><style type="text/css">#crate-search{background-image:url("../down-arrow.svg");}</style></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu" role="button">&#9776;</div><a href='../dropbox_backup_to_external_disk/index.html'><div class='logo-container rust-logo'><img src='../rust-logo.png' alt='logo'></div></a><p class="location">Crate dropbox_backup_to_external_disk</p><div class="block version"><p>Version 1.0.359</p></div><div class="sidebar-elems"><a id="all-types" href="all.html"><p>See all dropbox_backup_to_external_disk's items</p></a><div class="block items"><ul><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#functions">Functions</a></li></ul></div><p class="location"></p><div id="sidebar-vars" data-name="dropbox_backup_to_external_disk" data-ty="mod" data-relpath="../"></div><script defer src="../sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu"><img src="../brush.svg" width="18" height="18" alt="Pick another theme!"></button><div id="theme-choices" role="menu"></div></div><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><button type="button" class="help-button">?</button>
                <a id="settings-menu" href="../settings.html"><img src="../wheel.svg" width="18" height="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class="fqn"><span class="in-band">Crate <a class="mod" href="">dropbox_backup_to_external_disk</a><button id="copy-path" onclick="copy_path(this)">⎘</button></span><span class="out-of-band"><span id="render-detail"><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span><a class="srclink" href="../src/dropbox_backup_to_external_disk/lib.rs.html#1-281" title="goto source code">[src]</a></span></h1><div class="docblock"><p>dropbox_backup_to_external_disk lib.rs</p>
<h1 id="dropbox_backup_to_external_disk" class="section-header"><a href="#dropbox_backup_to_external_disk">dropbox_backup_to_external_disk</a></h1>
<p><strong>one way sync from dropbox to an external disc</strong><br />
<em><strong><a href="https://github.com/lucianobestia/dropbox_backup_to_external_disk/">repo</a>; version: 1.0.359  date: 2021-08-01 authors: Luciano Bestia</strong></em></p>
<p><a href="https://github.com/LucianoBestia/dropbox_backup_to_external_disk/"><img src="https://img.shields.io/badge/Lines_in_Rust-1258-green.svg" alt="Lines in Rust code" /></a>
<a href="https://github.com/LucianoBestia/dropbox_backup_to_external_disk/"><img src="https://img.shields.io/badge/Lines_in_Doc_comments-147-blue.svg" alt="Lines in Doc comments" /></a>
<a href="https://github.com/LucianoBestia/dropbox_backup_to_external_disk/"><img src="https://img.shields.io/badge/Lines_in_comments-110-purple.svg" alt="Lines in Comments" /></a>
<a href="https://github.com/LucianoBestia/dropbox_backup_to_external_disk/"><img src="https://img.shields.io/badge/Lines_in_examples-0-yellow.svg" alt="Lines in examples" /></a>
<a href="https://github.com/LucianoBestia/dropbox_backup_to_external_disk/"><img src="https://img.shields.io/badge/Lines_in_tests-0-orange.svg" alt="Lines in tests" /></a></p>
<p><a href="https://github.com/LucianoBestia/dropbox_backup_to_external_disk/blob/master/LICENSE"><img src="https://img.shields.io/badge/license-MIT-blue.svg" alt="Licence" /></a> <a href="https://github.com/LucianoBestia/dropbox_backup_to_external_disk/"><img src="https://github.com/LucianoBestia/dropbox_backup_to_external_disk/workflows/RustAction/badge.svg" alt="Rust" /></a></p>
<p>On my Dropbox “remote drive” I have more than 1 Terabyte of data in 200 000 files.<br />
I own now 4 notebooks and 2 android phones and 1 tablet and not a single one has an internal drive with more than 1 Terabyte. I use dropbox <code>Selective Sync</code> to sync only the bare minimum I temporarily need on the local device. But I want to have a backup of all of my data. I must have a backup. Better, I want to have 2 backups of all the data on 2 external hard disks in different locations. So if Dropbox go bankrupt, I still have all my data.<br />
The original Dropbox Sync app works great for the internal HD, but is “not recommended” for external drives. I also need only one way sync: from remote to local. There exist apps for that:</p>
<ul>
<li>rclone</li>
<li>dropbox_uploader</li>
</ul>
<p>But I wanted to write something mine for fun, learning Rust and using my own apps.
I have a lot of files, so I wanted to list them first, then compare with the local files and finally download them.<br />
Obsolete files will “move to trash folder”, so I can inspect what and how to remove manually.<br />
The dropbox remote storage will always be read_only, nothing will be modified there, never, no permission for that.</p>
<h2 id="try-it" class="section-header"><a href="#try-it">Try it</a></h2>
<p>You should be logged in Linux terminal with your account. So things you do, are not visible to others.<br />
You will set some local environment variables that are private/secret to your linux Session.<br />
After you logout from you Linux session the local environment variables will be deleted.<br />
You have to be in the project folder where cargo.toml is.<br />
Build the CLI:<br />
<code>$ cargo make debug</code><br />
Follow carefully the instructions.<br />
Before the first use, create your Dropbox app.<br />
Before every use generate your “short-lived access token” and in Linux bash write the “token” into the environment variable like this:<br />
<code>$ export DBX_OAUTH_TOKEN=here paste the token</code><br />
Make a temporary alias for easy of use (it lasts only for this session lifetime) :<br />
<code>$ alias dropbox_backup_to_external_disk=target/debug/dropbox_backup_to_external_disk</code><br />
Test the connection and permission:<br />
<code>$ dropbox_backup_to_external_disk test</code></p>
<p>Later, use <code>$ dropbox_backup_to_external_disk --help</code> to get all the instructions and commands.</p>
<p><img src="https://github.com/LucianoBestia/dropbox_backup_to_external_disk/raw/master/images/screenshot_1.png" alt="screenshot_1" title="screenshot_1" /> <img src="https://github.com/LucianoBestia/dropbox_backup_to_external_disk/raw/master/images/screenshot_2.png" alt="screenshot_2" title="screenshot_2" /> <img src="https://github.com/LucianoBestia/dropbox_backup_to_external_disk/raw/master/images/list_2.png" alt="list_2" title="list_2" /> <img src="https://github.com/LucianoBestia/dropbox_backup_to_external_disk/raw/master/images/list_3.png" alt="list_3" title="list_3" /> <img src="https://github.com/LucianoBestia/dropbox_backup_to_external_disk/raw/master/images/list_4.png" alt="list_4" title="list_4" /></p>
<h2 id="warning" class="section-header"><a href="#warning">Warning</a></h2>
<p>I don’t know why, but WSL2 sometimes does not see all the folders of the external disk.<br />
Instead of 12.000 folders it sees only 28 ???<br />
Be careful !<br />
I then restart my Win10 and the problem magically disappears.</p>
<h2 id="development" class="section-header"><a href="#development">Development</a></h2>
<p>I use WSL2 on Win10 to develope and execute this CLI in Debian Linux.<br />
The external disk path from WSL2 looks like this: <code>/mnt/d/DropBoxBackup1</code>. CLI lists the local files metadata in <code>temp_data/list_local_files.csv</code>.<br />
List all the files metadata from the remote Dropbox to the file <code>temp_data/list_remote_files.csv</code>.
Tab delimited with metadata: path (with name), datetime modified, size.
The remote path is not really case-sensitive. They try to make it case-preserve, but this apply only to the last part of the path. Before that it is random-case.
For big dropbox remotes it can take a while to complete. After the first level folders are listed, I use 3 threads in a ThreadPool to get sub-folders recursively in parallel. It makes it much faster. Also the download of files is in parallel on multiple threads.<br />
The sorting of lists is also done in parallel with the crate Rayon.<br />
Once the lists are complete the CLI will compare them and create files:<br />
<code>list_for_correct_time.csv</code><br />
<code>list_for_download.csv</code><br />
<code>list_for_trash.csv</code><br />
With this files the CLI will:<br />
<code>move_or_rename_local_files</code> using the content_hash to be sure they are equal<br />
<code>trash_from_list</code> will move the obsolete files into a trash folder<br />
<code>correct_time_from_list</code> sometimes it is needed<br />
<code>download_from_list</code> - this can take a lot of time and it can be stopped with ctrl+c</p>
<h2 id="dropbox-api2---stone-sdk" class="section-header"><a href="#dropbox-api2---stone-sdk">DropBox api2 - Stone sdk</a></h2>
<p>Dropbox has made a <code>Stone</code> thing that contains all the API definition. From there is possible to generate code boilerplate for different languages for the api-client.<br />
For Rust there is this quasi official project:<br />
<a href="https://crates.io/crates/dropbox-sdk">https://crates.io/crates/dropbox-sdk</a></p>
<h2 id="authorization-oauth2" class="section-header"><a href="#authorization-oauth2">Authorization OAuth2</a></h2>
<p>Authorization on the internet is a mess. Dropbox api uses OAuth2.
Every app must be authorized on Dropbox and have its own <code>app key</code> and <code>app secret</code>.<br />
For commercial programs they probably embed them into the binary code somehow. But for OpenSource projects it is not possible to keep a secret. So the workaround is: every user must create a new <code>dropbox app</code> exclusive only to him. Creating a new app is simple. This app will stay forever in <code>development status</code> in dropbox, to be more private and secure. The<br />
<code>$ dropbox_backup_to_external_disk --help</code><br />
has the detailed instructions.<br />
Then every time before use we need generate the “short-lived access token” for security reasons.<br />
<img src="https://github.com/LucianoBestia/dropbox_backup_to_external_disk/raw/master/images/dropbox_2.png" alt="dropbox_2" title="dropbox_2" /> <img src="https://github.com/LucianoBestia/dropbox_backup_to_external_disk/raw/master/images/dropbox_1.png" alt="dropbox_1" title="dropbox_1" /></p>
<h2 id="rename-or-move" class="section-header"><a href="#rename-or-move">rename or move</a></h2>
<p>Often a file is renamed or moved to another folder. I can try to recognize if there is the same file in list_for_trash and list_for download, but I cannot use the file path or name. Instead I use the metadata: size, date modified and content_hash.</p>
<h2 id="regex-adventure-with-non-breaking-space-and-crlf" class="section-header"><a href="#regex-adventure-with-non-breaking-space-and-crlf">REGEX adventure with non-breaking space and CRLF</a></h2>
<p>We all know space. But there are other non-visible characters that are very similar and sometimes impossible to distinguish. Tab is one of them, but it is not so difficult to spot with a quick try.<br />
But nbsp non-breaking space, often used in HTML is a catastrophe. There is no way to tell it apart from the normal space. I used a regex to find a match with some spaces. It worked right for a years. Yesterday it didn’t work. If I changed space to <code>\s</code> in the regex expression, it worked, but not with space. I tried everything and didn’t find the cause. Finally I deleted and inserted the space. It works. But how? After a detailed analysis I discovered it was a non-breakable space. This is unicode 160 or \xa0, instead of normal space unicode 32 \x20. Now I will try to find them all and replace with normal space. What a crazy world.<br />
And another REGEX surprise. I try to have all text files delimited with the unix standard LF. But somehow the windows standard got mixed and I didn’t recognize it. The regex for <code>end of line</code> $ didn’t work for CRLF. When I changed it to LF, the good life is back and all works.</p>
<h2 id="text-files" class="section-header"><a href="#text-files">Text files</a></h2>
<p>Simple text files are a terrible way to store data that needs to be changed. It is ok for write once and then read. But there is not a good way to modify only one line inside a big text file. The recommended approach is read all, modify, save all. If the memory is not big enough then use a buffer to read a segment, modify, save a segment, repeat to end.<br />
There is another approach called memory map to file, but everybody is trying to avoid it because some other process could modify the file when in use and make it garbage.<br />
Sounds like a database is always a better choice for more agile development.<br />
In this project I will create additional files that only append lines. Some kind of journal. And later use this to modify the big text files in one go. For example: list_just_downloaded_or_moved.csv is added to list_local_files.csv.</p>
</div><h2 id="modules" class="section-header"><a href="#modules">Modules</a></h2>
<table><tr class="module-item"><td><a class="mod" href="local_mod/index.html" title="dropbox_backup_to_external_disk::local_mod mod">local_mod</a></td><td class="docblock-short"><p>local_mod.rs
Module contains all functions for local external disk.</p>
</td></tr><tr class="module-item"><td><a class="mod" href="remote_mod/index.html" title="dropbox_backup_to_external_disk::remote_mod mod">remote_mod</a></td><td class="docblock-short"><p>remote_mod.rs
Module contains all the communication with the remote dropbox storage.</p>
</td></tr><tr class="module-item"><td><a class="mod" href="utils_mod/index.html" title="dropbox_backup_to_external_disk::utils_mod mod">utils_mod</a></td><td class="docblock-short"><p>utils_mod.rs
A module with often used functions. For every project I select only the functions I need for the project.</p>
</td></tr></table><h2 id="structs" class="section-header"><a href="#structs">Structs</a></h2>
<table><tr class="module-item"><td><a class="struct" href="struct.CLEAR_ALL.html" title="dropbox_backup_to_external_disk::CLEAR_ALL struct">CLEAR_ALL</a></td><td class="docblock-short"></td></tr><tr class="module-item"><td><a class="struct" href="struct.CLEAR_LINE.html" title="dropbox_backup_to_external_disk::CLEAR_LINE struct">CLEAR_LINE</a></td><td class="docblock-short"><p>ansi terminal - clears the line on the terminal from cursor to end of line</p>
</td></tr><tr class="module-item"><td><a class="struct" href="struct.GREEN.html" title="dropbox_backup_to_external_disk::GREEN struct">GREEN</a></td><td class="docblock-short"></td></tr><tr class="module-item"><td><a class="struct" href="struct.HIDE_CURSOR.html" title="dropbox_backup_to_external_disk::HIDE_CURSOR struct">HIDE_CURSOR</a></td><td class="docblock-short"></td></tr><tr class="module-item"><td><a class="struct" href="struct.RESET.html" title="dropbox_backup_to_external_disk::RESET struct">RESET</a></td><td class="docblock-short"></td></tr><tr class="module-item"><td><a class="struct" href="struct.UNHIDE_CURSOR.html" title="dropbox_backup_to_external_disk::UNHIDE_CURSOR struct">UNHIDE_CURSOR</a></td><td class="docblock-short"></td></tr><tr class="module-item"><td><a class="struct" href="struct.YELLOW.html" title="dropbox_backup_to_external_disk::YELLOW struct">YELLOW</a></td><td class="docblock-short"></td></tr></table><h2 id="functions" class="section-header"><a href="#functions">Functions</a></h2>
<table><tr class="module-item"><td><a class="fn" href="fn.add_just_downloaded_to_list_local.html" title="dropbox_backup_to_external_disk::add_just_downloaded_to_list_local fn">add_just_downloaded_to_list_local</a></td><td class="docblock-short"><p>add lines from just_downloaded to list_local. Only before compare.</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.at_line.html" title="dropbox_backup_to_external_disk::at_line fn">at_line</a></td><td class="docblock-short"></td></tr><tr class="module-item"><td><a class="fn" href="fn.at_pos.html" title="dropbox_backup_to_external_disk::at_pos fn">at_pos</a></td><td class="docblock-short"></td></tr><tr class="module-item"><td><a class="fn" href="fn.compare_lists.html" title="dropbox_backup_to_external_disk::compare_lists fn">compare_lists</a></td><td class="docblock-short"><p>compare list: the lists must be already sorted for this to work correctly</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.correct_time_from_list.html" title="dropbox_backup_to_external_disk::correct_time_from_list fn">correct_time_from_list</a></td><td class="docblock-short"><p>modify the files from list_for_correct_time</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.download_from_list.html" title="dropbox_backup_to_external_disk::download_from_list fn">download_from_list</a></td><td class="docblock-short"><p>download files from list</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.download_one_file.html" title="dropbox_backup_to_external_disk::download_one_file fn">download_one_file</a></td><td class="docblock-short"><p>download one file</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.get_pos.html" title="dropbox_backup_to_external_disk::get_pos fn">get_pos</a></td><td class="docblock-short"></td></tr><tr class="module-item"><td><a class="fn" href="fn.get_short_lived_access_token.html" title="dropbox_backup_to_external_disk::get_short_lived_access_token fn">get_short_lived_access_token</a></td><td class="docblock-short"><p>get token from env variable</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.list_and_sync.html" title="dropbox_backup_to_external_disk::list_and_sync fn">list_and_sync</a></td><td class="docblock-short"><p>list and sync is the complete process for backup in one command</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.list_local.html" title="dropbox_backup_to_external_disk::list_local fn">list_local</a></td><td class="docblock-short"><p>list all local files and folders. It can take some time.</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.list_remote.html" title="dropbox_backup_to_external_disk::list_remote fn">list_remote</a></td><td class="docblock-short"><p>get remote list in parallel
first get the first level of folders and then request in parallel sub-folders recursively</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.list_remote_folder.html" title="dropbox_backup_to_external_disk::list_remote_folder fn">list_remote_folder</a></td><td class="docblock-short"><p>list remote folder</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.move_or_rename_local_files.html" title="dropbox_backup_to_external_disk::move_or_rename_local_files fn">move_or_rename_local_files</a></td><td class="docblock-short"><p>Files are often moved or renamed
After compare, the same file (with different path or name) will be in the list_for_trash and in the list_for_download.
First for every trash line, we search list_for_download for same size and modified.
If found, get the remote_metadata with content_hash and calculate local_content_hash.
If they are equal move or rename, else nothing: it will be trashed and downloaded eventually.
Remove also the lines in files list_for_trash and list_for_download.</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.ns_elapsed.html" title="dropbox_backup_to_external_disk::ns_elapsed fn">ns_elapsed</a></td><td class="docblock-short"><p>returns the elapsed nanoseconds</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.ns_print_ms.html" title="dropbox_backup_to_external_disk::ns_print_ms fn">ns_print_ms</a></td><td class="docblock-short"><p>print elapsed time in milliseconds and returns the new now in nanoseconds</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.ns_print_ns.html" title="dropbox_backup_to_external_disk::ns_print_ns fn">ns_print_ns</a></td><td class="docblock-short"><p>print elapsed time in nanoseconds and returns the new now in nanoseconds</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.ns_start.html" title="dropbox_backup_to_external_disk::ns_start fn">ns_start</a></td><td class="docblock-short"><p>returns the now in nanoseconds</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.remote_content_hash.html" title="dropbox_backup_to_external_disk::remote_content_hash fn">remote_content_hash</a></td><td class="docblock-short"><p>get content_hash from remote</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.save_base_path.html" title="dropbox_backup_to_external_disk::save_base_path fn">save_base_path</a></td><td class="docblock-short"><p>saves the base local path for later commands like “/mnt/f/DropBoxBackup1”</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.sort_remote_list_and_write_to_file.html" title="dropbox_backup_to_external_disk::sort_remote_list_and_write_to_file fn">sort_remote_list_and_write_to_file</a></td><td class="docblock-short"><p>sort and write to file</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.sort_string_lines.html" title="dropbox_backup_to_external_disk::sort_string_lines fn">sort_string_lines</a></td><td class="docblock-short"><p>sort string lines case insensitive</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.start_mouse_terminal.html" title="dropbox_backup_to_external_disk::start_mouse_terminal fn">start_mouse_terminal</a></td><td class="docblock-short"></td></tr><tr class="module-item"><td><a class="fn" href="fn.sync_only.html" title="dropbox_backup_to_external_disk::sync_only fn">sync_only</a></td><td class="docblock-short"><p>sync_only can be stopped and then restarted if downloading takes a lot of time.
no need to repeat the “list” that takes a lot of timeS</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.test_connection.html" title="dropbox_backup_to_external_disk::test_connection fn">test_connection</a></td><td class="docblock-short"><p>test authentication with dropbox.com</p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.trash_from_list.html" title="dropbox_backup_to_external_disk::trash_from_list fn">trash_from_list</a></td><td class="docblock-short"><p>move to trash folder the files from list_for_trash
ignore if the file does not exist anymore</p>
</td></tr></table></section><section id="search" class="content hidden"></section><div id="rustdoc-vars" data-root-path="../" data-current-crate="dropbox_backup_to_external_disk" data-search-index-js="../search-index.js" data-search-js="../search.js"></div>
    <script src="../main.js"></script></body></html>